<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Our Voice â€” Our Rights</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body>
  <div class="container glass">
    <h1>à¤¹à¤®à¤¾à¤°à¥€ à¤†à¤µà¤¾à¤œà¤¼ || Our Voice</h1>
    <!-- <p class="subtitle">Check MGNREGA performance for your district. Simple, large text and month-wise view.</p> -->
    <p class="subtitle">
      View MGNREGA performance for your district in <strong>Madhya Pradesh</strong> ðŸ‡®ðŸ‡³  
      <br>Optimized for faster fetch and simpler monthly view.
    </p>

    <form action="{{ url_for('district_page') }}" method="POST" id="mainForm" class="form">
      <label class="label">State</label>
      <select name="state_name" id="stateSelect" required>
        <option value="">Select State</option>
        {% for s in states %}
          <option value="{{ s }}">{{ s }}</option>
        {% endfor %}
      </select>

      <label class="label">Financial Year</label>
      <select name="fin_year" id="yearSelect" required>
        <option value="2024-2025">2024-2025</option>
        <option value="2023-2024">2023-2024</option>
        <option value="2022-2023">2022-2023</option>
      </select>

      <label class="label">District</label>
      <select name="district" id="districtSelect" required>
        <option value="">Select District</option>
      </select>

      <div style="margin-top:12px;">
        <button type="submit" class="btn">Show Report</button>
      </div>
    </form>

    <p class="hint">If your browser permits, we'll try to guess your district automatically.</p>
<p id="detected" style="display:none; text-align:center; font-weight:bold; margin-top:10px; color:green;"></p>
  
</div>

<script>
  // Injected safely as JSON
  const districtData = JSON.parse('{{ district_data | tojson | safe }}');

  const stateSelect = document.getElementById('stateSelect');
  const districtSelect = document.getElementById('districtSelect');

  function populateDistrictsFor(stateName) {
    districtSelect.innerHTML = '<option value="">Select District</option>';
    if (!stateName) return;
    const s = (districtData.states || []).find(x => x.state.toUpperCase() === stateName.toUpperCase());
    if (!s) return;
    s.districts.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d;
      opt.textContent = d;
      districtSelect.appendChild(opt);
    });
  }

  stateSelect.addEventListener('change', (e) => populateDistrictsFor(e.target.value));

  // --- Unified Auto Location Detection ---
// Detect user location and auto-select using Nominatim + GeoNames fallback
async function detectLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async position => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      const nominatimURL = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
      console.log("Nominatim API URL:", nominatimURL);

      let district = null, state = null;

      try {
        const res = await fetch(nominatimURL);
        const data = await res.json();
        state = data.address?.state;
        district =
          data.address?.district ||
          data.address?.county ||
          data.address?.state_district ||
          data.address?.city_district ||
          data.address?.city;
      } catch (err) {
        console.warn("Nominatim failed:", err);
      }

      // Fallback: use GeoNames if district is missing
      if (!district) {
        const geoNamesURL = `https://secure.geonames.org/findNearbyPlaceNameJSON?lat=${lat}&lng=${lon}&username=demo`; 
        // ðŸ” replace 'demo' with your GeoNames username
        console.log("GeoNames API URL:", geoNamesURL);
        try {
          const res2 = await fetch(geoNamesURL);
          const data2 = await res2.json();
          if (data2.geonames && data2.geonames.length > 0) {
            const place = data2.geonames[0];
            district = place.adminName2; // district equivalent
            state = state || place.adminName1;
          }
        } catch (err) {
          console.warn("GeoNames failed:", err);
        }
      }

      console.log("Detected State:", state, "District:", district);

      if (state) stateSelect.value = state.toUpperCase();
      stateSelect.dispatchEvent(new Event("change"));

      setTimeout(() => {
        if (district) {
          const match = Array.from(districtSelect.options).find(opt =>
            opt.value.toUpperCase().includes(district.toUpperCase())
          );
          if (match) districtSelect.value = match.value;
        }
      }, 1000);
    });
  }
}

  window.onload = detectLocation;
</script>



</body>
</html>


