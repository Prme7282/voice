<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Our Voice ‚Äî Our Rights</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body>
  <div class="container glass">
    <h1>‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§Ü‡§µ‡§æ‡§ú‡§º ‚Äî Our Voice</h1>
    <p class="subtitle">Check MGNREGA performance for your district. Simple, large text and month-wise view.</p>

    <form action="{{ url_for('district_page') }}" method="POST" id="mainForm" class="form">
      <label class="label">State</label>
      <select name="state_name" id="stateSelect" required>
        <option value="">Select State</option>
        {% for s in states %}
          <option value="{{ s }}">{{ s }}</option>
        {% endfor %}
      </select>

      <label class="label">Financial Year</label>
      <select name="fin_year" id="yearSelect" required>
        <option value="2024-2025">2024-2025</option>
        <option value="2023-2024">2023-2024</option>
        <option value="2022-2023">2022-2023</option>
      </select>

      <label class="label">District</label>
      <select name="district" id="districtSelect" required>
        <option value="">Select District</option>
      </select>

      <div style="margin-top:12px;">
        <button type="submit" class="btn">Show Report</button>
      </div>
    </form>

    <p class="hint">If your browser permits, we'll try to guess your district automatically.</p>
<p id="detected" style="display:none; text-align:center; font-weight:bold; margin-top:10px; color:green;"></p>
  
</div>

<script>
  const districtData = JSON.parse('{{ district_data | tojson | safe }}');
  const stateSelect = document.getElementById('stateSelect');
  const districtSelect = document.getElementById('districtSelect');
  const detected = document.getElementById('detected');

  function populateDistrictsFor(stateName) {
    districtSelect.innerHTML = '<option value="">Select District</option>';
    if (!stateName) return;
    const s = (districtData.states || []).find(
      x => x.state.toUpperCase() === stateName.toUpperCase()
    );
    if (!s) return;
    s.districts.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d;
      opt.textContent = d;
      districtSelect.appendChild(opt);
    });
  }

  stateSelect.addEventListener('change', e => populateDistrictsFor(e.target.value));

  async function detectLocation() {
    if (!navigator.geolocation) return;

    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      const nominatimURL = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
      console.log("Nominatim API:", nominatimURL);

      let district = null, state = null;

      try {
        const res = await fetch(nominatimURL);
        const data = await res.json();
        state = data.address?.state;
        district =
          data.address?.district ||
          data.address?.county ||
          data.address?.state_district ||
          data.address?.city_district ||
          data.address?.city;
      } catch (err) {
        console.warn("Nominatim failed:", err);
      }

      if (!district) {
        const geoNamesURL = `https://secure.geonames.org/findNearbyPlaceNameJSON?lat=${lat}&lng=${lon}&username=demo`;
        console.log("GeoNames API:", geoNamesURL);
        try {
          const res2 = await fetch(geoNamesURL);
          const data2 = await res2.json();
          if (data2.geonames?.length > 0) {
            const place = data2.geonames[0];
            district = place.adminName2;
            state = state || place.adminName1;
          }
        } catch (err) {
          console.warn("GeoNames failed:", err);
        }
      }

      console.log("Detected:", state, district);

      if (state) {
        // find closest match for the state
        const stateMatch = Array.from(stateSelect.options).find(opt =>
          opt.value.toUpperCase().includes(state.toUpperCase())
        );
        if (stateMatch) {
          stateSelect.value = stateMatch.value;
          populateDistrictsFor(stateMatch.value);

          // Wait until districts are populated, then select district
          setTimeout(() => {
            if (district) {
              const districtMatch = Array.from(districtSelect.options).find(opt =>
                opt.value.toUpperCase().includes(district.toUpperCase())
              );
              if (districtMatch) {
                districtSelect.value = districtMatch.value;
                detected.textContent = `üìç Detected: ${districtMatch.value}, ${stateMatch.value}`;
                detected.style.display = "block";
              }
            }
          }, 800);
        }
      }
    });
  }

  window.onload = detectLocation;
</script>




</body>
</html>
